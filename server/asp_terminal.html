<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASP System Command Terminal</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: #1a1a1a;
            color: #00ff00;
            height: 100vh;
            overflow: hidden;
        }

        .terminal-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            background: #000;
            border: 2px solid #333;
        }

        .terminal-header {
            background: #2d2d2d;
            color: #fff;
            padding: 8px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #444;
        }

        .header-title {
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-info {
            font-size: 12px;
            color: #ccc;
        }

        .clear-button {
            background: #444;
            color: #fff;
            border: none;
            padding: 4px 8px;
            cursor: pointer;
            border-radius: 3px;
        }

        .clear-button:hover {
            background: #555;
        }

        .terminal-body {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            background: #000;
        }

        .welcome-message {
            color: #0088ff;
            margin-bottom: 20px;
            text-align: center;
        }

        .welcome-logo {
            margin-bottom: 10px;
            color: #00ff88;
        }

        .command-entry {
            margin-bottom: 16px;
        }

        .command-line {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }

        .prompt {
            color: #00ff00;
            font-weight: bold;
        }

        .command-text {
            color: #ffffff;
        }

        .command-time {
            color: #666;
            font-size: 11px;
            margin-left: auto;
        }

        .command-output {
            margin-left: 20px;
            padding: 8px;
            border-left: 2px solid #444;
            background: #0a0a0a;
        }

        .command-output.success {
            border-left-color: #00ff00;
        }

        .command-output.error {
            border-left-color: #ff0000;
            color: #ff6666;
        }

        .command-output pre {
            white-space: pre-wrap;
            font-family: inherit;
        }

        .terminal-input {
            display: flex;
            align-items: center;
            background: #111;
            padding: 12px 16px;
            border-top: 1px solid #333;
        }

        .input-prompt {
            color: #00ff00;
            font-weight: bold;
            margin-right: 8px;
        }

        .command-input {
            flex: 1;
            background: transparent;
            border: none;
            color: #ffffff;
            font-family: inherit;
            font-size: 14px;
            outline: none;
        }

        .execute-button {
            background: #0066cc;
            color: #fff;
            border: none;
            padding: 6px 12px;
            margin-left: 8px;
            cursor: pointer;
            border-radius: 3px;
        }

        .execute-button:hover:not(:disabled) {
            background: #0088ff;
        }

        .execute-button:disabled {
            background: #444;
            cursor: not-allowed;
        }

        .executing-indicator {
            color: #ffaa00;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 16px;
        }

        .loading-dots {
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }

        .help-panel {
            background: #222;
            color: #aaa;
            padding: 8px 16px;
            font-size: 11px;
            border-top: 1px solid #333;
        }

        .smed-display {
            background: #001122;
            border: 1px solid #0066cc;
            margin: 10px 0;
            padding: 15px;
            border-radius: 5px;
        }

        .smed-title {
            color: #00aaff;
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
        }

        .smed-table {
            width: 100%;
            border-collapse: collapse;
        }

        .smed-table th {
            background: #003366;
            color: #ffffff;
            padding: 8px;
            border: 1px solid #0066cc;
            text-align: left;
        }

        .smed-table td {
            padding: 6px 8px;
            border: 1px solid #0066cc;
            color: #cccccc;
        }

        .smed-table tr:nth-child(even) {
            background: #001a33;
        }

        .smed-footer {
            margin-top: 10px;
            padding: 5px;
            background: #003300;
            text-align: center;
            font-size: 12px;
            color: #88cc88;
        }

        .status-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            z-index: 1000;
        }

        .status-connected {
            background: #004400;
            color: #88ff88;
            border: 1px solid #00aa00;
        }

        .status-disconnected {
            background: #440000;
            color: #ff8888;
            border: 1px solid #aa0000;
        }
    </style>
</head>
<body>
    <div class="status-indicator" id="status-indicator">WebSocket: Disconnected</div>
    
    <div class="terminal-container">
        <!-- Header -->
        <div class="terminal-header">
            <div class="header-title">
                <span>üñ•Ô∏è</span>
                <span>ASP System Command Terminal</span>
            </div>
            <div class="header-info">
                <span>User: ASPUSER</span>
                <span> | </span>
                <span>Volume: DISK01</span>
                <span> | </span>
                <span id="system-time"></span>
            </div>
            <button class="clear-button" onclick="clearHistory()" title="Clear terminal">
                üóëÔ∏è
            </button>
        </div>

        <!-- Terminal Body -->
        <div class="terminal-body" id="terminal-body">
            <!-- Welcome Message -->
            <div class="welcome-message" id="welcome-message">
                <div class="welcome-logo">
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë           ASP System Command             ‚ïë
‚ïë              Terminal v2.0               ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
                </div>
                <div class="welcome-text">
                    Welcome to ASP System Command Terminal.<br/>
                    Type <strong>HELP</strong> for available commands.<br/>
                    WebSocket connection initializing...
                </div>
            </div>
        </div>

        <!-- Command Input -->
        <form class="terminal-input" id="command-form">
            <span class="input-prompt">ASP></span>
            <input
                type="text"
                id="command-input"
                class="command-input"
                placeholder="Enter ASP command... (e.g., CALL PGM-MSGSAMPLEBROWSERMENU.TESTLIB,VOL-DISK01)"
                autocomplete="off"
                autofocus
            />
            <button type="submit" id="execute-button" class="execute-button">
                Execute
            </button>
        </form>

        <!-- Help Panel -->
        <div class="help-panel">
            <strong>Shortcuts:</strong> Tab (autocomplete), ‚Üë (previous command), Ctrl+L (clear screen)
        </div>
    </div>

    <script>
        // Terminal state
        let commandHistory = [];
        let currentCommandIndex = -1;
        let isExecuting = false;
        let socket = null;
        
        // DOM elements
        const terminalBody = document.getElementById('terminal-body');
        const commandInput = document.getElementById('command-input');
        const executeButton = document.getElementById('execute-button');
        const commandForm = document.getElementById('command-form');
        const statusIndicator = document.getElementById('status-indicator');
        const welcomeMessage = document.getElementById('welcome-message');

        // Initialize terminal
        document.addEventListener('DOMContentLoaded', function() {
            updateSystemTime();
            setInterval(updateSystemTime, 1000);
            initializeWebSocket();
            setupEventListeners();
        });

        function updateSystemTime() {
            document.getElementById('system-time').textContent = new Date().toLocaleString();
        }

        function setupEventListeners() {
            commandForm.addEventListener('submit', handleSubmit);
            commandInput.addEventListener('keydown', handleKeyDown);
        }

        function initializeWebSocket() {
            console.log('[DEBUG] Initializing WebSocket connection...');
            
            try {
                socket = io('http://localhost:8000');
                
                socket.on('connect', function() {
                    console.log('[DEBUG] WebSocket connected:', socket.id);
                    updateConnectionStatus(true);
                    
                    // Register as web terminal
                    const registration = {
                        terminal_id: 'webui',
                        client_type: 'web_terminal',
                        capabilities: ['smed_display', 'command_execution'],
                        timestamp: new Date().toISOString()
                    };
                    
                    socket.emit('register_terminal', registration);
                    console.log('[DEBUG] Terminal registration sent');
                });

                socket.on('disconnect', function() {
                    console.log('[DEBUG] WebSocket disconnected');
                    updateConnectionStatus(false);
                });

                socket.on('smed_data_direct', function(data) {
                    console.log('[DEBUG] Received SMED data:', data);
                    displaySmedData(data);
                });

                socket.on('smed_data', function(data) {
                    console.log('[DEBUG] Received legacy SMED data:', data);
                    displaySmedData(data);
                });

                socket.on('terminal_registered', function(data) {
                    console.log('[DEBUG] Terminal registration confirmed:', data);
                    addLogMessage(`Terminal registered: ${data.terminal_id}`, 'success');
                });

                socket.on('error', function(error) {
                    console.error('[DEBUG] WebSocket error:', error);
                    addLogMessage(`WebSocket error: ${error}`, 'error');
                });

            } catch (error) {
                console.error('[DEBUG] Failed to initialize WebSocket:', error);
                updateConnectionStatus(false);
            }
        }

        function updateConnectionStatus(connected) {
            if (connected) {
                statusIndicator.textContent = 'WebSocket: Connected';
                statusIndicator.className = 'status-indicator status-connected';
            } else {
                statusIndicator.textContent = 'WebSocket: Disconnected';
                statusIndicator.className = 'status-indicator status-disconnected';
            }
        }

        async function handleSubmit(e) {
            e.preventDefault();
            const command = commandInput.value.trim();
            
            if (!command || isExecuting) return;
            
            await executeCommand(command);
        }

        async function executeCommand(command) {
            if (isExecuting) return;
            
            console.log('[DEBUG] Executing command:', command);
            
            setExecuting(true);
            const timestamp = new Date();
            
            // Add command to history
            addCommandToHistory(command, timestamp);
            
            // Show executing indicator
            showExecutingIndicator(command);
            
            try {
                const response = await fetch('/api/asp-command', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        command: command,
                        user: 'ASPUSER'
                    }),
                });

                let output = '';
                let success = false;

                if (response.ok) {
                    const result = await response.json();
                    output = result.output || result.error || 'Command executed successfully.';
                    success = result.success !== false;
                    
                    console.log('[DEBUG] Command result:', result);
                    
                    // Send command execution log to server
                    sendLogToServer('INFO', `Command executed: ${command}`, {
                        success: success,
                        has_output: !!result.output,
                        result_keys: Object.keys(result || {}),
                        command_type: 'asp-command'
                    });
                    
                    // Check if this might be a SMED-related program
                    if (result && (result.action === 'display_map' || result.fields || result.map_file || result.map_name)) {
                        console.log('[DEBUG] Detected SMED-related program output');
                        sendLogToServer('INFO', 'SMED program detected', {
                            action: result.action,
                            has_fields: !!result.fields,
                            map_file: result.map_file,
                            map_name: result.map_name
                        });
                        
                        // Try to display SMED data if present
                        if (result.action === 'display_map' || result.fields) {
                            console.log('[DEBUG] Attempting to display SMED data from command result');
                            displaySmedData(result);
                        }
                    }
                } else {
                    const errorText = await response.text();
                    output = `[ERROR] Server error (${response.status}): ${errorText}`;
                    success = false;
                    
                    console.log('[DEBUG] Command failed:', response.status, errorText);
                }

                // Remove executing indicator
                hideExecutingIndicator();
                
                // Add output to terminal
                addCommandOutput(command, output, timestamp, success);
                
            } catch (error) {
                console.error('[DEBUG] Command execution error:', error);
                
                hideExecutingIndicator();
                addCommandOutput(command, `[ERROR] Network error: ${error.message}`, timestamp, false);
            }

            setExecuting(false);
            commandInput.value = '';
            commandInput.focus();
        }

        function handleKeyDown(e) {
            if (e.key === 'ArrowUp') {
                e.preventDefault();
                if (commandHistory.length > 0) {
                    currentCommandIndex = Math.max(0, currentCommandIndex);
                    commandInput.value = commandHistory[commandHistory.length - 1 - currentCommandIndex].command;
                    currentCommandIndex = Math.min(commandHistory.length - 1, currentCommandIndex + 1);
                }
            } else if (e.key === 'ArrowDown') {
                e.preventDefault();
                if (currentCommandIndex > 0) {
                    currentCommandIndex--;
                    commandInput.value = commandHistory[commandHistory.length - 1 - currentCommandIndex].command;
                } else {
                    currentCommandIndex = -1;
                    commandInput.value = '';
                }
            } else if (e.ctrlKey && e.key === 'l') {
                e.preventDefault();
                clearHistory();
            }
        }

        function setExecuting(executing) {
            isExecuting = executing;
            executeButton.disabled = executing;
            commandInput.disabled = executing;
            executeButton.textContent = executing ? 'Executing...' : 'Execute';
        }

        function addCommandToHistory(command, timestamp) {
            commandHistory.push({ command, timestamp });
            currentCommandIndex = -1;
        }

        function showExecutingIndicator(command) {
            const indicator = document.createElement('div');
            indicator.className = 'executing-indicator';
            indicator.id = 'executing-indicator';
            indicator.innerHTML = `
                <span class="prompt">ASP></span>
                <span class="command-text">${command}</span>
                <span class="loading-dots">Executing...</span>
            `;
            
            terminalBody.appendChild(indicator);
            scrollToBottom();
        }

        function hideExecutingIndicator() {
            const indicator = document.getElementById('executing-indicator');
            if (indicator) {
                indicator.remove();
            }
        }

        function addCommandOutput(command, output, timestamp, success) {
            // Hide welcome message on first command
            if (welcomeMessage) {
                welcomeMessage.style.display = 'none';
            }
            
            const entry = document.createElement('div');
            entry.className = 'command-entry';
            
            entry.innerHTML = `
                <div class="command-line">
                    <span class="prompt">ASP></span>
                    <span class="command-text">${command}</span>
                    <span class="command-time">[${timestamp.toLocaleTimeString()}]</span>
                </div>
                <div class="command-output ${success ? 'success' : 'error'}">
                    <pre>${output}</pre>
                </div>
            `;
            
            terminalBody.appendChild(entry);
            scrollToBottom();
        }

        function addLogMessage(message, type = 'info') {
            const entry = document.createElement('div');
            entry.className = 'command-entry';
            
            entry.innerHTML = `
                <div class="command-output ${type}">
                    <pre>[${new Date().toLocaleTimeString()}] ${message}</pre>
                </div>
            `;
            
            terminalBody.appendChild(entry);
            scrollToBottom();
        }
        
        function sendLogToServer(level, message, details = {}) {
            try {
                fetch('http://localhost:8000/api/logs', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        level: level,
                        source: 'web-terminal',
                        message: message,
                        details: details
                    })
                }).catch(error => {
                    console.error('[DEBUG] Failed to send log to server:', error);
                });
            } catch (error) {
                console.error('[DEBUG] Error in sendLogToServer:', error);
            }
        }

        function displaySmedData(data) {
            console.log('[DEBUG] displaySmedData() called with data:', data);
            console.log('[DEBUG] Data type:', typeof data);
            console.log('[DEBUG] Data keys:', Object.keys(data || {}));
            
            // Send debug log to API server
            sendLogToServer('DEBUG', 'displaySmedData() function called', {
                data_type: typeof data,
                data_keys: Object.keys(data || {}),
                has_type: !!(data && data.type),
                has_data: !!(data && data.data),
                has_fields: !!(data && data.fields)
            });
            
            if (welcomeMessage) {
                welcomeMessage.style.display = 'none';
                console.log('[DEBUG] Welcome message hidden');
            }
            
            const smedDisplay = document.createElement('div');
            smedDisplay.className = 'smed-display';
            console.log('[DEBUG] Created SMED display element');
            
            // Handle different data formats
            if (data.type === 'smed_map' && data.data) {
                console.log('[DEBUG] Processing as new simplified employee data format');
                smedDisplay.innerHTML = createEmployeeTable(data);
                sendLogToServer('INFO', 'SMED MAP displayed - Employee table format', {map_name: data.map_name || 'Unknown'});
            } else if (data.fields) {
                console.log('[DEBUG] Processing as legacy SMED format');
                smedDisplay.innerHTML = createLegacySmedDisplay(data);
                sendLogToServer('INFO', 'SMED MAP displayed - Legacy format', {map_file: data.map_file || 'Unknown'});
            } else {
                console.log('[DEBUG] Using fallback display format');
                smedDisplay.innerHTML = `
                    <div class="smed-title">SMED Data Received</div>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                `;
                sendLogToServer('WARNING', 'SMED MAP displayed - Fallback format', {data_structure: 'unknown'});
            }
            
            terminalBody.appendChild(smedDisplay);
            console.log('[DEBUG] SMED display element appended to terminal body');
            
            scrollToBottom();
            console.log('[DEBUG] Scrolled to bottom');
            
            addLogMessage(`SMED data displayed: ${data.map_name || data.map_file || 'Unknown'}`, 'success');
            console.log('[DEBUG] displaySmedData() completed successfully');
        }

        function createEmployeeTable(data) {
            const headers = data.headers || ['ID', 'Name', 'Department'];
            const rows = data.data || [];
            const title = data.title || 'Employee Information';
            const pageInfo = data.page_info || {};
            const functionKeys = data.function_keys || 'F3=Quit';
            const status = data.status || 'Ready';
            
            let tableHTML = `
                <div class="smed-title">${title}</div>
                <table class="smed-table">
                    <thead>
                        <tr>
            `;
            
            headers.forEach(header => {
                tableHTML += `<th>${header}</th>`;
            });
            
            tableHTML += `</tr></thead><tbody>`;
            
            rows.forEach(row => {
                tableHTML += '<tr>';
                row.forEach(cell => {
                    tableHTML += `<td>${cell}</td>`;
                });
                tableHTML += '</tr>';
            });
            
            tableHTML += `
                    </tbody>
                </table>
                <div class="smed-footer">
                    ${status} | Page ${pageInfo.current || 1} of ${pageInfo.total || 1} | ${functionKeys}
                </div>
            `;
            
            return tableHTML;
        }

        function createLegacySmedDisplay(data) {
            const fields = data.fields || {};
            const mapName = data.map_file || 'Unknown Map';
            
            let fieldsHTML = '<div class="smed-title">SMED Map: ' + mapName + '</div>';
            
            // Group fields by type (employee records)
            const employees = [];
            for (let i = 1; i <= 10; i++) {
                const emp = {};
                if (fields[`EMP${i}_ID`]) {
                    emp.id = fields[`EMP${i}_ID`];
                    emp.name = fields[`EMP${i}_NAME`];
                    emp.dept = fields[`EMP${i}_DEPT`];
                    emp.salary = fields[`EMP${i}_SALARY`];
                    emp.hiredate = fields[`EMP${i}_HIREDATE`];
                    emp.status = fields[`EMP${i}_STATUS`];
                    employees.push(emp);
                }
            }
            
            if (employees.length > 0) {
                fieldsHTML += `
                    <table class="smed-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Department</th>
                                <th>Salary</th>
                                <th>Hire Date</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                employees.forEach(emp => {
                    fieldsHTML += `
                        <tr>
                            <td>${emp.id || ''}</td>
                            <td>${emp.name || ''}</td>
                            <td>${emp.dept || ''}</td>
                            <td>${emp.salary || ''}</td>
                            <td>${emp.hiredate || ''}</td>
                            <td>${emp.status || ''}</td>
                        </tr>
                    `;
                });
                
                fieldsHTML += '</tbody></table>';
            }
            
            // Add other fields
            const pageInfo = fields.PAGEINFO || '';
            const statusMsg = fields.STATUSMSG || '';
            
            if (pageInfo || statusMsg) {
                fieldsHTML += `<div class="smed-footer">${pageInfo} | ${statusMsg}</div>`;
            }
            
            return fieldsHTML;
        }

        function clearHistory() {
            terminalBody.innerHTML = '';
            welcomeMessage.style.display = 'block';
            terminalBody.appendChild(welcomeMessage);
            commandHistory = [];
            currentCommandIndex = -1;
            commandInput.focus();
        }

        function scrollToBottom() {
            terminalBody.scrollTop = terminalBody.scrollHeight;
        }

        // Focus input when clicking anywhere in terminal
        document.addEventListener('click', function() {
            if (!isExecuting) {
                commandInput.focus();
            }
        });
    </script>
</body>
</html>