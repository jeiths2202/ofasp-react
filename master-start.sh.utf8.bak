#!/bin/bash
# OpenASP AX 全体開発環境マスター起動スクリプト (PROJECT_CONTEXT.json 基準)

echo "🚀 OpenASP AX 全体開発環境起動..."
echo "========================================="

# カラー定義
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# プロジェクトルート
APP_ROOT="/home/aspuser/app"

# ログディレクトリ作成
mkdir -p "$APP_ROOT/logs"

# 既存プロセス整理
echo -e "${YELLOW}📋 既存プロセス整理中...${NC}"
pkill -f "flask.*3003" 2>/dev/null
pkill -f "react-scripts.*3000" 2>/dev/null
pkill -f "react-scripts.*3005" 2>/dev/null
pkill -f "react-scripts.*3007" 2>/dev/null
pkill -f "python.*api_server" 2>/dev/null
sleep 3

# 1. Python EBCDIC 変換サービス開始 (ポート 3003) - 他のサービスが依存するため最初に開始
echo -e "\n${GREEN}🐍 Python 変換サービス開始 (ポート 3003)...${NC}"
cd $APP_ROOT/ofasp-refactor/python-service
FLASK_PORT=3003 python -c "from src.api.app import api; api.run()" > $APP_ROOT/logs/python-service.log 2>&1 &
PYTHON_PID=$!
echo "Python サービス PID: $PYTHON_PID"

# 2. SMED Map Viewer 開始 (ポート 3000) - メインアプリ
echo -e "\n${GREEN}🗺️  SMED Map Viewer 開始 (ポート 3000)...${NC}"
cd $APP_ROOT
npm start > $APP_ROOT/logs/smed-viewer.log 2>&1 &
SMED_PID=$!
echo "SMED Viewer PID: $SMED_PID"

# 3. OpenASP Refactor 開始 (ポート 3005)
echo -e "\n${GREEN}⚛️  OpenASP Refactor 開始 (ポート 3005)...${NC}"
cd $APP_ROOT/ofasp-refactor
PORT=3005 npm start > $APP_ROOT/logs/ofasp-refactor.log 2>&1 &
REFACTOR_PID=$!
echo "Refactor アプリ PID: $REFACTOR_PID"

# 4. ASP Manager 開始 (ポート 3007)
echo -e "\n${GREEN}🎯 ASP Manager 開始 (ポート 3007)...${NC}"
cd $APP_ROOT/asp-manager
PORT=3007 npm start > $APP_ROOT/logs/asp-manager.log 2>&1 &
MANAGER_PID=$!
echo "Manager アプリ PID: $MANAGER_PID"

# 5. API Server 開始 (ポート 8000) - バックエンドサービス
echo -e "\n${GREEN}🔧 API Server 開始 (ポート 8000)...${NC}"
cd $APP_ROOT/server
python api_server.py > $APP_ROOT/logs/api-server.log 2>&1 &
API_SERVER_PID=$!
echo "API Server PID: $API_SERVER_PID"

# サービス開始待機
echo -e "\n${YELLOW}⏳ サービス開始待機中 (20秒)...${NC}"
for i in {1..20}; do
    echo -n "."
    sleep 1
done
echo ""

# サービス状態確認
echo -e "\n${YELLOW}🔍 サービス状態確認...${NC}"
echo "========================================="

# Python サービス確認
if curl -s http://localhost:3003/health > /dev/null; then
    echo -e "${GREEN}✅ Python 変換サービス${NC} - http://localhost:3003"
else
    echo -e "${RED}❌ Python 変換サービス開始失敗${NC}"
    echo "   ログ確認: tail -f $APP_ROOT/logs/python-service.log"
fi

# SMED Map Viewer 確認
if curl -s http://localhost:3000 > /dev/null; then
    echo -e "${GREEN}✅ SMED Map Viewer${NC} - http://localhost:3000"
else
    echo -e "${RED}❌ SMED Map Viewer 開始失敗${NC}"
    echo "   ログ確認: tail -f $APP_ROOT/logs/smed-viewer.log"
fi

# OpenASP Refactor 確認
if curl -s http://localhost:3005 > /dev/null; then
    echo -e "${GREEN}✅ OpenASP Refactor${NC} - http://localhost:3005"
else
    echo -e "${RED}❌ OpenASP Refactor 開始失敗${NC}"
    echo "   ログ確認: tail -f $APP_ROOT/logs/ofasp-refactor.log"
fi

# ASP Manager 確認
if curl -s http://localhost:3007 > /dev/null; then
    echo -e "${GREEN}✅ ASP Manager${NC} - http://localhost:3007"
else
    echo -e "${RED}❌ ASP Manager 開始失敗${NC}"
    echo "   ログ確認: tail -f $APP_ROOT/logs/asp-manager.log"
fi

# API Server 確認 (404応答も正常として処理)
if curl -s -o /dev/null -w "%{http_code}" http://localhost:8000 | grep -E "200|404" > /dev/null; then
    echo -e "${GREEN}✅ API Server${NC} - http://localhost:8000"
else
    echo -e "${RED}❌ API Server 開始失敗${NC}"
    echo "   ログ確認: tail -f $APP_ROOT/logs/api-server.log"
fi

# プロセス情報保存
echo -e "\n${YELLOW}💾 プロセス情報保存...${NC}"
cat > $APP_ROOT/.running_services << EOF
PYTHON_SERVICE_PID=$PYTHON_PID
SMED_VIEWER_PID=$SMED_PID
REFACTOR_APP_PID=$REFACTOR_PID
MANAGER_APP_PID=$MANAGER_PID
API_SERVER_PID=$API_SERVER_PID
STARTED_AT=$(date)
EOF

echo "========================================="
echo -e "${GREEN}🎉 OpenASP AX 開発環境起動完了!${NC}"
echo ""
echo "📱 主要サービス接続URL:"
echo "   - SMED Map Viewer: http://localhost:3000"
echo "   - Python 変換サービス: http://localhost:3003"
echo "   - OpenASP Refactor: http://localhost:3005"
echo "   - ASP Manager: http://localhost:3007"
echo "   - API Server: http://localhost:8000"
echo ""
echo "📋 ログファイル:"
echo "   - Python サービス: $APP_ROOT/logs/python-service.log"
echo "   - SMED Viewer: $APP_ROOT/logs/smed-viewer.log"
echo "   - Refactor: $APP_ROOT/logs/ofasp-refactor.log"
echo "   - Manager: $APP_ROOT/logs/asp-manager.log"
echo "   - API Server: $APP_ROOT/logs/api-server.log"
echo ""
echo "🛑 全体停止コマンド:"
echo "   $APP_ROOT/master-stop.sh"
echo ""