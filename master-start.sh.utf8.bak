#!/bin/bash
# OpenASP AX å…¨ä½“é–‹ç™ºç’°å¢ƒãƒžã‚¹ã‚¿ãƒ¼èµ·å‹•ã‚¹ã‚¯ãƒªãƒ—ãƒˆ (PROJECT_CONTEXT.json åŸºæº–)

echo "ðŸš€ OpenASP AX å…¨ä½“é–‹ç™ºç’°å¢ƒèµ·å‹•..."
echo "========================================="

# ã‚«ãƒ©ãƒ¼å®šç¾©
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆ
APP_ROOT="/home/aspuser/app"

# ãƒ­ã‚°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
mkdir -p "$APP_ROOT/logs"

# æ—¢å­˜ãƒ—ãƒ­ã‚»ã‚¹æ•´ç†
echo -e "${YELLOW}ðŸ“‹ æ—¢å­˜ãƒ—ãƒ­ã‚»ã‚¹æ•´ç†ä¸­...${NC}"
pkill -f "flask.*3003" 2>/dev/null
pkill -f "react-scripts.*3000" 2>/dev/null
pkill -f "react-scripts.*3005" 2>/dev/null
pkill -f "react-scripts.*3007" 2>/dev/null
pkill -f "python.*api_server" 2>/dev/null
sleep 3

# 1. Python EBCDIC å¤‰æ›ã‚µãƒ¼ãƒ“ã‚¹é–‹å§‹ (ãƒãƒ¼ãƒˆ 3003) - ä»–ã®ã‚µãƒ¼ãƒ“ã‚¹ãŒä¾å­˜ã™ã‚‹ãŸã‚æœ€åˆã«é–‹å§‹
echo -e "\n${GREEN}ðŸ Python å¤‰æ›ã‚µãƒ¼ãƒ“ã‚¹é–‹å§‹ (ãƒãƒ¼ãƒˆ 3003)...${NC}"
cd $APP_ROOT/ofasp-refactor/python-service
FLASK_PORT=3003 python -c "from src.api.app import api; api.run()" > $APP_ROOT/logs/python-service.log 2>&1 &
PYTHON_PID=$!
echo "Python ã‚µãƒ¼ãƒ“ã‚¹ PID: $PYTHON_PID"

# 2. SMED Map Viewer é–‹å§‹ (ãƒãƒ¼ãƒˆ 3000) - ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒª
echo -e "\n${GREEN}ðŸ—ºï¸  SMED Map Viewer é–‹å§‹ (ãƒãƒ¼ãƒˆ 3000)...${NC}"
cd $APP_ROOT
npm start > $APP_ROOT/logs/smed-viewer.log 2>&1 &
SMED_PID=$!
echo "SMED Viewer PID: $SMED_PID"

# 3. OpenASP Refactor é–‹å§‹ (ãƒãƒ¼ãƒˆ 3005)
echo -e "\n${GREEN}âš›ï¸  OpenASP Refactor é–‹å§‹ (ãƒãƒ¼ãƒˆ 3005)...${NC}"
cd $APP_ROOT/ofasp-refactor
PORT=3005 npm start > $APP_ROOT/logs/ofasp-refactor.log 2>&1 &
REFACTOR_PID=$!
echo "Refactor ã‚¢ãƒ—ãƒª PID: $REFACTOR_PID"

# 4. ASP Manager é–‹å§‹ (ãƒãƒ¼ãƒˆ 3007)
echo -e "\n${GREEN}ðŸŽ¯ ASP Manager é–‹å§‹ (ãƒãƒ¼ãƒˆ 3007)...${NC}"
cd $APP_ROOT/asp-manager
PORT=3007 npm start > $APP_ROOT/logs/asp-manager.log 2>&1 &
MANAGER_PID=$!
echo "Manager ã‚¢ãƒ—ãƒª PID: $MANAGER_PID"

# 5. API Server é–‹å§‹ (ãƒãƒ¼ãƒˆ 8000) - ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹
echo -e "\n${GREEN}ðŸ”§ API Server é–‹å§‹ (ãƒãƒ¼ãƒˆ 8000)...${NC}"
cd $APP_ROOT/server
python api_server.py > $APP_ROOT/logs/api-server.log 2>&1 &
API_SERVER_PID=$!
echo "API Server PID: $API_SERVER_PID"

# ã‚µãƒ¼ãƒ“ã‚¹é–‹å§‹å¾…æ©Ÿ
echo -e "\n${YELLOW}â³ ã‚µãƒ¼ãƒ“ã‚¹é–‹å§‹å¾…æ©Ÿä¸­ (20ç§’)...${NC}"
for i in {1..20}; do
    echo -n "."
    sleep 1
done
echo ""

# ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹ç¢ºèª
echo -e "\n${YELLOW}ðŸ” ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹ç¢ºèª...${NC}"
echo "========================================="

# Python ã‚µãƒ¼ãƒ“ã‚¹ç¢ºèª
if curl -s http://localhost:3003/health > /dev/null; then
    echo -e "${GREEN}âœ… Python å¤‰æ›ã‚µãƒ¼ãƒ“ã‚¹${NC} - http://localhost:3003"
else
    echo -e "${RED}âŒ Python å¤‰æ›ã‚µãƒ¼ãƒ“ã‚¹é–‹å§‹å¤±æ•—${NC}"
    echo "   ãƒ­ã‚°ç¢ºèª: tail -f $APP_ROOT/logs/python-service.log"
fi

# SMED Map Viewer ç¢ºèª
if curl -s http://localhost:3000 > /dev/null; then
    echo -e "${GREEN}âœ… SMED Map Viewer${NC} - http://localhost:3000"
else
    echo -e "${RED}âŒ SMED Map Viewer é–‹å§‹å¤±æ•—${NC}"
    echo "   ãƒ­ã‚°ç¢ºèª: tail -f $APP_ROOT/logs/smed-viewer.log"
fi

# OpenASP Refactor ç¢ºèª
if curl -s http://localhost:3005 > /dev/null; then
    echo -e "${GREEN}âœ… OpenASP Refactor${NC} - http://localhost:3005"
else
    echo -e "${RED}âŒ OpenASP Refactor é–‹å§‹å¤±æ•—${NC}"
    echo "   ãƒ­ã‚°ç¢ºèª: tail -f $APP_ROOT/logs/ofasp-refactor.log"
fi

# ASP Manager ç¢ºèª
if curl -s http://localhost:3007 > /dev/null; then
    echo -e "${GREEN}âœ… ASP Manager${NC} - http://localhost:3007"
else
    echo -e "${RED}âŒ ASP Manager é–‹å§‹å¤±æ•—${NC}"
    echo "   ãƒ­ã‚°ç¢ºèª: tail -f $APP_ROOT/logs/asp-manager.log"
fi

# API Server ç¢ºèª (404å¿œç­”ã‚‚æ­£å¸¸ã¨ã—ã¦å‡¦ç†)
if curl -s -o /dev/null -w "%{http_code}" http://localhost:8000 | grep -E "200|404" > /dev/null; then
    echo -e "${GREEN}âœ… API Server${NC} - http://localhost:8000"
else
    echo -e "${RED}âŒ API Server é–‹å§‹å¤±æ•—${NC}"
    echo "   ãƒ­ã‚°ç¢ºèª: tail -f $APP_ROOT/logs/api-server.log"
fi

# ãƒ—ãƒ­ã‚»ã‚¹æƒ…å ±ä¿å­˜
echo -e "\n${YELLOW}ðŸ’¾ ãƒ—ãƒ­ã‚»ã‚¹æƒ…å ±ä¿å­˜...${NC}"
cat > $APP_ROOT/.running_services << EOF
PYTHON_SERVICE_PID=$PYTHON_PID
SMED_VIEWER_PID=$SMED_PID
REFACTOR_APP_PID=$REFACTOR_PID
MANAGER_APP_PID=$MANAGER_PID
API_SERVER_PID=$API_SERVER_PID
STARTED_AT=$(date)
EOF

echo "========================================="
echo -e "${GREEN}ðŸŽ‰ OpenASP AX é–‹ç™ºç’°å¢ƒèµ·å‹•å®Œäº†!${NC}"
echo ""
echo "ðŸ“± ä¸»è¦ã‚µãƒ¼ãƒ“ã‚¹æŽ¥ç¶šURL:"
echo "   - SMED Map Viewer: http://localhost:3000"
echo "   - Python å¤‰æ›ã‚µãƒ¼ãƒ“ã‚¹: http://localhost:3003"
echo "   - OpenASP Refactor: http://localhost:3005"
echo "   - ASP Manager: http://localhost:3007"
echo "   - API Server: http://localhost:8000"
echo ""
echo "ðŸ“‹ ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«:"
echo "   - Python ã‚µãƒ¼ãƒ“ã‚¹: $APP_ROOT/logs/python-service.log"
echo "   - SMED Viewer: $APP_ROOT/logs/smed-viewer.log"
echo "   - Refactor: $APP_ROOT/logs/ofasp-refactor.log"
echo "   - Manager: $APP_ROOT/logs/asp-manager.log"
echo "   - API Server: $APP_ROOT/logs/api-server.log"
echo ""
echo "ðŸ›‘ å…¨ä½“åœæ­¢ã‚³ãƒžãƒ³ãƒ‰:"
echo "   $APP_ROOT/master-stop.sh"
echo ""