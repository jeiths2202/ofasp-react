#!/bin/bash
# OpenASP AX 全体開発環境終了スクリプト

echo "🛑 OpenASP AX 全体開発環境終了..."
echo "========================================="

# カラー定義
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# 保存されたPIDファイル読み込み
if [ -f /home/aspuser/app/.running_services ]; then
    source /home/aspuser/app/.running_services
    echo -e "${GREEN}保存されたプロセス情報を見つけました。${NC}"
else
    echo -e "${YELLOW}保存されたプロセス情報がありません。プロセス名で終了します。${NC}"
fi

# プロセス終了
echo -e "\n${YELLOW}プロセス終了中...${NC}"

# Python サービス終了
echo -n "Python 変換サービス終了... "
pkill -f "flask.*3003" 2>/dev/null
pkill -f "python.*api.run" 2>/dev/null
if [ ! -z "$PYTHON_SERVICE_PID" ]; then
    kill $PYTHON_SERVICE_PID 2>/dev/null
fi
echo -e "${GREEN}✓${NC}"

# SMED Map Viewer 終了
echo -n "SMED Map Viewer 終了... "
pkill -f "react-scripts.*3000" 2>/dev/null
if [ ! -z "$SMED_VIEWER_PID" ]; then
    kill $SMED_VIEWER_PID 2>/dev/null
fi
echo -e "${GREEN}✓${NC}"

# OpenASP Refactor 終了
echo -n "OpenASP Refactor 終了... "
pkill -f "react-scripts.*3005" 2>/dev/null
if [ ! -z "$REFACTOR_APP_PID" ]; then
    kill $REFACTOR_APP_PID 2>/dev/null
fi
echo -e "${GREEN}✓${NC}"

# ASP Manager 終了
echo -n "ASP Manager 終了... "
pkill -f "react-scripts.*3007" 2>/dev/null
if [ ! -z "$MANAGER_APP_PID" ]; then
    kill $MANAGER_APP_PID 2>/dev/null
fi
echo -e "${GREEN}✓${NC}"

# API Server 終了
echo -n "API Server 終了... "
pkill -f "python.*api_server" 2>/dev/null
if [ ! -z "$API_SERVER_PID" ]; then
    kill $API_SERVER_PID 2>/dev/null
fi
echo -e "${GREEN}✓${NC}"

# 関連ノードプロセス整理
echo -n "関連ノードプロセス整理... "
pkill -f "webpack-dev-server" 2>/dev/null
pkill -f "fork-ts-checker" 2>/dev/null
echo -e "${GREEN}✓${NC}"

# PIDファイル削除
rm -f /home/aspuser/app/.running_services

# ポート確認
echo -e "\n${YELLOW}ポート状態確認...${NC}"
for port in 3000 3003 3005 3007 8000; do
    if lsof -i :$port > /dev/null 2>&1; then
        echo -e "${RED}⚠️  ポート $port まだ使用中${NC}"
    else
        echo -e "${GREEN}✓ ポート $port 解放済み${NC}"
    fi
done

echo ""
echo "========================================="
echo -e "${GREEN}🎉 OpenASP AX 開発環境が終了されました。${NC}"
echo ""